package task1.tests.echo;

public class EchoClient extends Task {
    public EchoClient(Broker broker, Runnable r) {
        super(broker, r);  // Appel du constructeur de Task
    }

    public static void main(String[] args) {
        Broker broker = new BrokerImpl("ClientBroker"); // Création du Broker
        EchoClient client = new EchoClient(broker, () -> {
            try {
                // Connexion au serveur
                Channel channel = broker.connect("ServerBroker", 12345);

                // Envoi d'une séquence de bytes (de 1 à 255)
                byte[] sequence = new byte[255];
                for (int i = 0; i < 255; i++) {
                    sequence[i] = (byte) (i + 1);
                }

                channel.write(sequence, 0, sequence.length);

                // Lecture de la réponse (doit être identique à la séquence envoyée)
                byte[] echo = new byte[255];
                int bytesRead = channel.read(echo, 0, echo.length);
                for (int i = 0; i < bytesRead; i++) {
                    if (echo[i] != sequence[i]) {
                        System.out.println("Erreur d'echo à l'octet : " + i);
                    }
                }

                channel.disconnect();
            } catch (Exception e) {
                e.printStackTrace();
            }
        });
        client.start();  // Démarrage du thread du client
    }
}


